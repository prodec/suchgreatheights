var connection = new WebSocket("ws://localhost:7331");
var lineString =
      [[7.88469, 71.07135],
       [-59.40125, 41.69139],
       [-7.04546, -36.63786],
       [-74.4086, 22.88231],
       [-16.6123, 56.69622],
       [67.62662, 22.60376],
       [-67.44965, 22.8078],
       [16.61035, 78.31199],
       [-72.52064, -52.68435],
       [67.31029, 46.88188],
       [73.5545, -7.76819],
       [-36.10982, -83.26945],
       [0.28897, -22.57241],
       [-49.93925, -85.84552],
       [-12.28768, 35.25362],
       [-78.44426, -50.34586],
       [-60.08923, -73.86188],
       [-69.30102, 68.38924],
       [-37.08554, 10.90074],
       [3.2398, -58.62774],
       [10.34404, 42.71417],
       [1.12001, -46.7282],
       [15.91156, 49.50932],
       [8.53941, 1.04366],
       [69.21378, 45.36497],
       [76.47659, -80.98149],
       [19.569490000000002, -16.39392],
       [-23.77599, 75.43035],
       [62.92125, 46.68951],
       [20.11145, -57.09167],
       [45.28993, 71.26653],
       [-13.19238, 83.68468],
       [11.2528, -56.07971],
       [34.64046, 51.17051],
       [-43.67288, 13.38055],
       [-51.95254, -55.21979],
       [0.07213, -66.11036],
       [-73.72142, 56.54003],
       [-16.47243, -30.90107],
       [-30.37796, 10.42212]];

var interpolatedLs =
      [[7.88469,71.07135],[-59.40125,41.69139],[-59.40125,41.691390000000006],[-34.13564479469793,4.743566309371385],[-7.04546,-36.63786],[-7.04546,-36.63786],[-74.4086,22.88231],[-74.4086,22.882310000000015],[-16.6123,56.69622],[-16.6123,56.69622],[67.62662,22.60376],[67.62662,22.60376],[19.2978597182757,22.676798120942486],[-67.44965,22.8078],[-67.44965,22.807799999999997],[-37.621342290330226,52.22980280181294],[16.61035,78.31199],[16.61035,78.31199],[-3.669432734647269,65.17469447545382],[-23.94921546929454,39.34470836860681],[-44.2289982039418,-1.0078563824913904],[-72.52064,-52.68435],[-72.52064,-52.68435],[-35.24785239864135,-29.973989620429467],[2.0249352027173106,-0.6790247985967137],[67.31029,46.88188],[67.31029,46.88187999999999],[73.5545,-7.76819],[73.5545,-7.7681899999999935],[45.58822511577772,-42.62521947122372],[17.621950231555427,-65.1303339865524],[-36.10982,-83.26945],[-36.10982,-83.26945],[-23.881246413301092,-74.84991531393564],[0.28897,-22.57241],[0.28897,-22.57241000000001],[-14.452684387486208,-56.724126047798094],[-29.194338774972415,-74.75450725429336],[-49.93925,-85.84552],[-49.93925,-85.0511287],[-41.70352242933362,-78.66751410963124],[-33.46779485866725,-64.33368588251732],[-25.232067288000867,-34.778063184790945],[-12.28768,35.25362],[-12.28768,35.25362000000001],[-39.67991254260331,-2.1009935675135005],[-78.44426,-50.34586],[-78.44426,-50.34586],[-60.08923,-73.86188],[-60.08923,-73.86188],[-62.23961900963859,-53.54998277103386],[-64.39000801927715,-15.187106610528925],[-66.54039702891573,31.239092729243467],[-69.30102,68.38924],[-69.30102,68.38924000000002],[-37.08554,10.90074],[-37.08554,10.900739999999995],[3.2398,-58.62774],[3.2398,-58.62774],[6.093708514616649,-23.806170075270476],[10.34404,42.71417],[10.34404,42.71416999999999],[5.918594558037491,-0.7974185131273167],[1.12001,-46.7282],[1.12001,-46.7282],[7.553317650080826,-5.075656674721688],[15.91156,49.50932],[15.911560000000001,49.50932000000001],[8.53941,1.04366],[8.53941,1.0436600000000054],[69.21378,45.36497],[69.21378,45.364969999999985],[70.99838613686522,2.7199001842735857],[72.78299227373044,-41.41251550023473],[74.56759841059568,-68.0089261968678],[76.47659,-80.98149],[76.47659,-80.98149],[56.95914273741969,-70.63595556246933],[19.569490000000002,-16.39392],[19.569490000000002,-16.39392],[4.743414078172876,28.16778593547543],[-23.77599,75.43035],[-23.77599,75.43035],[14.906060887465571,66.06566591331548],[62.92125,46.68951],[62.92125,46.68950999999999],[47.012561918821085,7.269634709723179],[20.11145,-57.09167],[20.11145,-57.09167],[27.066736750803997,-21.52795234324699],[34.022023501608,24.945001733220042],[45.28993,71.26653],[45.28993,71.26653000000002],[-13.19238,83.68468],[-13.192380000000002,83.68468000000001],[-8.171996129109463,75.45086447266404],[-3.1516122582189228,57.08852973319887],[1.868771612671613,21.2976095491686],[11.2528,-56.07971],[11.2528,-56.079710000000006],[19.953081399225702,-20.07784298572564],[34.64046,51.17051],[34.64046,51.17051000000001],[-43.67288,13.38055],[-43.672880000000006,13.380549999999994],[-51.95254,-55.21979],[-51.95254,-55.21979000000001],[0.07213,-66.11036],[0.07213,-66.11036],[-20.39315549854153,-41.142250797870304],[-40.85844099708306,-1.4333536493524646],[-73.72142,56.54003],[-73.72142,56.54003000000001],[-49.959092627571465,25.861669834962246],[-16.47243,-30.90107],[-16.47243,-30.901069999999994],[-30.37796,10.42212]];

var map;

connection.onmessage = dispatch;

function initialize() {
  var mapOptions = {
    center: { lat: lineString[0][1], lng: lineString[0][0] },
    zoom: 12,
    mapTypeId: google.maps.MapTypeId.TERRAIN
  };

  map = new google.maps.Map(document.getElementById('map-canvas'),
                            mapOptions);
  google.maps.event.addListener(map, "mousemove", requestAltitude());

  drawRoute(map);
  drawInterpolation(map);
}

function drawRoute(map) {
  var path = new google.maps.Polyline({
    path: lineString.map(function(p) {
      return new google.maps.LatLng(p[1], p[0]);
    }),
    //geodesic: true,
    strokeColor: "#FF0000",
    strokeWeight: 3
  });

  path.setMap(map);
}

function drawInterpolation(map) {
  var path = new google.maps.Polyline({
    path: interpolatedLs.map(function(p) {
      return new google.maps.LatLng(p[1], p[0]);
    }),
    // geodesic: true,
    strokeColor: "#00FF00",
    strokeWeight: 3
  });

  console.log(path);
  path.setMap(map);
}

function dispatch(resp) {
  var result = JSON.parse(resp.data);

  if (result.profile) {
    displayRoute(result);
  } else {
    displayAltitude(result);
  }
}

function requestAltitude() {
  var lastSent;

  return function(me) {
    var latLng = me.latLng,
        now = new Date;

    if (!lastSent || (now - lastSent) > 40) {
      connection.send(JSON.stringify({
        command: "point_altitude",
        lat: latLng.lat(),
        lng: latLng.lng(),
        sent_at: +new Date
      }));

      lastSent = now;
    }
  }
}

function displayAltitude(result) {
  document.getElementById("current-altitude").innerText = result.data.altitude;
}

function displayRoute(resp) {
  var path = new google.maps.Polyline({
    path: resp.profile.map(function(p) {
      return new google.maps.LatLng(p[1], p[0]);
    }),
    geodesic: true,
    strokeColor: "#0000FF",
    strokeWeight: 3
  });

  path.setMap(map);
}

google.maps.event.addDomListener(window, 'load', initialize);
document.getElementById("send-route").addEventListener("click", function() {
  console.log("clicked");
  connection.send(JSON.stringify({
    command: "route_profile",
    route: {
      type: "LineString",
      coordinates: lineString
    }
  }));}
);
