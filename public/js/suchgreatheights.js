var connection = new WebSocket("ws://localhost:7331");
var lineString =
      [
        [34.63458, -70.9861],
        [-64.82829, 8.68597]
      ];

var interpolatedLs =
      [[34.63458, -70.9861],
       [34.63458, -70.9861],
       [33.13358215408163, -69.78376584807116],
       [31.63258430816326, -68.58143169614233],
       [30.13158646224489, -67.3790975442135],
       [28.63058861632652, -66.17676339228467],
       [27.12959077040815, -64.97442924035583],
       [25.62859292448978, -63.77209508842701],
       [24.12759507857141, -62.56976093649818],
       [22.62659723265304, -61.367426784569346],
       [21.12559938673467, -60.16509263264051],
       [19.6246015408163, -58.962758480711685],
       [18.123603694897927, -57.76042432878285],
       [16.622605848979557, -56.558090176854016],
       [15.121608003061187, -55.355756024925185],
       [13.62061015714282, -54.15342187299636],
       [12.119612311224447, -52.95108772106752],
       [10.618614465306077, -51.7487535691387],
       [9.117616619387707, -50.54641941720986],
       [7.616618773469337, -49.34408526528103],
       [6.115620927550967, -48.1417511133522],
       [4.6146230816325975, -46.93941696142337],
       [3.1136252357142276, -45.73708280949454],
       [1.612627389795854, -44.53474865756571],
       [0.11162954387749124, -43.332414505636876],
       [-1.3893683020408858, -42.13008035370804],
       [-2.8903661479592557, -40.927746201779215],
       [-4.391363993877626, -39.72541204985038],
       [-5.892361839795996, -38.52307789792155],
       [-7.393359685714358, -37.32074374599272],
       [-8.894357531632735, -36.118409594063884],
       [-10.395355377551105, -34.91607544213506],
       [-11.896353223469475, -33.71374129020622],
       [-13.397351069387845, -32.5114071382774],
       [-14.898348915306215, -31.309072986348568],
       [-16.399346761224585, -30.10673883441973],
       [-17.900344607142955, -28.904404682490906],
       [-19.401342453061325, -27.702070530562068],
       [-20.902340298979695, -26.499736378633237],
       [-22.403338144898065, -25.297402226704413],
       [-23.904335990816435, -24.095068074775575],
       [-25.405333836734805, -22.892733922846745],
       [-26.90633168265318, -21.690399770917914],
       [-28.407329528571545, -20.488065618989083],
       [-29.908327374489915, -19.285731467060252],
       [-31.40932522040829, -18.08339731513142],
       [-32.910323066326654, -16.88106316320259],
       [-34.41132091224502, -15.67872901127376],
       [-35.91231875816341, -14.476394859344921],
       [-37.41331660408177, -13.27406070741609],
       [-38.914314450000134, -12.071726555487267],
       [-40.41531229591851, -10.869392403558436],
       [-41.916310141836874, -9.667058251629605],
       [-43.41730798775525, -8.464724099700767],
       [-44.91830583367363, -7.262389947771936],
       [-46.41930367959199, -6.0600557958431125],
       [-47.920301525510354, -4.8577216439142745],
       [-49.42129937142872, -3.6553874919854508],
       [-50.92229721734711, -2.453053340056613],
       [-52.42329506326547, -1.2507191881277748],
       [-53.92429290918383, -0.04838503619895107],
       [-55.42529075510221, 1.1539491157298727],
       [-56.92628860102057, 2.3562832676587107],
       [-58.42728644693895, 3.5586174195875486],
       [-59.92828429285733, 4.760951571516372],
       [-61.42928213877569, 5.963285723445196],
       [-62.93027998469405, 7.165619875374034],
       [-64.43127783061243, 8.367954027302858],
       [-65.93227567653081, 9.570288179231696],
       [-67.43327352244917, 10.772622331160534],
       [-68.93427136836753, 11.974956483089358],
       [-70.43526921428591, 13.177290635018181],
       [-71.93626706020427, 14.37962478694702],
       [-73.43726490612265, 15.581958938875857],
       [-74.93826275204103, 16.78429309080468],
       [-76.43926059795939, 17.98662724273352],
       [-77.94025844387775, 19.188961394662343],
       [-79.44125628979613, 20.391295546591166],
       [-80.9422541357145, 21.59362969852002],
       [-82.44325198163287, 22.795963850448842],
       [-83.94424982755125, 23.998298002377666],
       [-85.44524767346961, 25.200632154306504],
       [-86.94624551938797, 26.402966306235328],
       [-88.44724336530636, 27.605300458164166],
       [-89.94824121122473, 28.807634610093004],
       [-91.44923905714309, 30.009968762021828],
       [-92.95023690306145, 31.21230291395065],
       [-94.45123474897983, 32.41463706587949],
       [-95.95223259489822, 33.61697121780833],
       [-97.45323044081658, 34.81930536973715],
       [-98.95422828673495, 36.021639521665975],
       [-100.45522613265331, 37.22397367359481],
       [-101.95622397857167, 38.42630782552364],
       [-103.45722182449003, 39.628641977452475],
       [-104.9582196704084, 40.8309761293813],
       [-106.45921751632682, 42.03331028131015],
       [-107.96021536224518, 43.235644433238974],
       [-109.46121320816354, 44.43797858516781],
       [-110.9622110540819, 45.640312737096636],
       [-112.46320890000027, 46.84264688902546],
       [-113.96420674591863, 48.0449810409543]];

var map;

connection.onmessage = dispatch;

function initialize() {
  var mapOptions = {
    center: { lat: lineString[0][1], lng: lineString[0][0] },
    zoom: 12,
    mapTypeId: google.maps.MapTypeId.TERRAIN
  };

  map = new google.maps.Map(document.getElementById('map-canvas'),
                            mapOptions);
  google.maps.event.addListener(map, "mousemove", requestAltitude);

  drawRoute(map);
  drawInterpolation(map);
}

function drawRoute(map) {
  var path = new google.maps.Polyline({
    path: lineString.map(function(p) {
      return new google.maps.LatLng(p[1], p[0]);
    }),
    //geodesic: true,
    strokeColor: "#FF0000",
    strokeWeight: 3
  });

  path.setMap(map);
}

function drawInterpolation(map) {
  var path = new google.maps.Polyline({
    path: interpolatedLs.map(function(p) {
      return new google.maps.LatLng(p[1], p[0]);
    }),
    // geodesic: true,
    strokeColor: "#00FF00",
    strokeWeight: 3
  });

  console.log(path);
  path.setMap(map);
}

function dispatch(resp) {
  var result = JSON.parse(resp.data);

  if (result.profile) {
    displayRoute(result);
  } else {
    displayAltitude(result);
  }
}

function requestAltitude(me) {
  var latLng = me.latLng;

  connection.send(JSON.stringify({
    command: "point_altitude",
    lat: latLng.lat(),
    lon: latLng.lng()
  }));
}

function displayAltitude(result) {
  document.getElementById("current-altitude").innerText = result.altitude;
}

function displayRoute(resp) {
  var path = new google.maps.Polyline({
    path: resp.profile.map(function(p) {
      return new google.maps.LatLng(p[1], p[0]);
    }),
    geodesic: true,
    strokeColor: "#0000FF",
    strokeWeight: 3
  });

  path.setMap(map);
}

google.maps.event.addDomListener(window, 'load', initialize);
document.getElementById("send-route").addEventListener("click", function() {
  console.log("clicked");
  connection.send(JSON.stringify({
    command: "route_profile",
    route: {
      type: "LineString",
      coordinates: lineString
    }
  }));}
);
