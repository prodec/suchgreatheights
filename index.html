<html>
  <head>
    <title>Foo foo</title>

    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCLtVUTJMdQigZD69BembPWbjSQLLamyzw"></script>
  </head>

  <body>
    <div id="map-canvas" style="width: 800px; height: 800px">
    </div>

    <button id="send-route">Enviar Rota</button>

    <div id="current-altitude">
    </div>

    <script type="text/javascript">
     var connection = new WebSocket("ws://localhost:7331");
     var lineString = [
       [-41.123, -21.456],
       [-42.123, -22.456]
     ];
     var map;

     connection.onmessage = dispatch;

     function initialize() {
       var mapOptions = {
         center: { lat: lineString[0][1], lng: lineString[0][0] },
         zoom: 12,
         mapTypeId: google.maps.MapTypeId.TERRAIN
       };

       map = new google.maps.Map(document.getElementById('map-canvas'),
                                     mapOptions);
       google.maps.event.addListener(map, "mousemove", requestAltitude);

       drawRoute(map);
     }

     function drawRoute(map) {
       var path = new google.maps.Polyline({
         path: lineString.map(function(p) {
           return new google.maps.LatLng(p[1], p[0]);
         }),
         geodesic: true,
         strokeColor: "#FF0000",
         strokeWeight: 3
       });

       path.setMap(map);
     }

     function dispatch(resp) {
       var result = JSON.parse(resp.data);

       if (result.profile) {
         displayRoute(result);
       } else {
         displayAltitude(result);
       }
     }

     function requestAltitude(me) {
       var latLng = me.latLng;

       connection.send(JSON.stringify({
         command: "point_altitude",
         lat: latLng.lat(),
         lon: latLng.lng()
       }));
     }

     function displayAltitude(result) {
       document.getElementById("current-altitude").innerText = result.altitude;
     }

     function displayRoute(resp) {
       var path = new google.maps.Polyline({
         path: resp.profile.map(function(p) {
         return new google.maps.LatLng(p[1], p[0]);
         }),
         geodesic: true,
         strokeColor: "#0000FF",
         strokeWeight: 3
       });

       path.setMap(map);
     }

     google.maps.event.addDomListener(window, 'load', initialize);
     document.getElementById("send-route").addEventListener("click", function() {
       console.log("clicked");
       connection.send(JSON.stringify({
         command: "route_profile",
         route: {
           type: "LineString",
           coordinates: lineString
         }
       }));
     });
    </script>
  </body>
</html>
